<!DOCTYPE html>

<html lang="en" data-content_root="../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Working with File System, Sockets, and Pipes &#8212; bisa  documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=5ecbeea2" />
    <link rel="stylesheet" type="text/css" href="../_static/basic.css?v=b08954a9" />
    <link rel="stylesheet" type="text/css" href="../_static/alabaster.css?v=27fed22d" />
    <script src="../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../_static/doctools.js?v=9bcbadda"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Intermediate Representation" href="ir.html" />
    <link rel="prev" title="Optimization considerations" href="speed.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="working-with-file-system-sockets-and-pipes">
<h1>Working with File System, Sockets, and Pipes<a class="headerlink" href="#working-with-file-system-sockets-and-pipes" title="Link to this heading">¶</a></h1>
<p>It’s very important to be able to control the environment that emulated programs
see, including how symbolic data is introduced from the environment! bisa has a
robust series of abstractions to help you set up the environment you want.</p>
<p>The root of any interaction with the filesystem, sockets, pipes, or terminals is
a SimFile object. A SimFile is a <em>storage</em> abstraction that defines a sequence
of bytes, symbolic or otherwise. There are several kinds of SimFiles which store
their data very differently - the two easiest examples are <code class="docutils literal notranslate"><span class="pre">SimFile</span></code> (the base
class is actually called <code class="docutils literal notranslate"><span class="pre">SimFileBase</span></code>), which stores files as a flat
address-space of data, and <code class="docutils literal notranslate"><span class="pre">SimPackets</span></code>, which stores a sequence of
variable-sized reads. The former is best for modeling programs that need to
perform seeks on their files, and is the default storage for opened files, while
the latter is best for modeling programs that depend on short-reads or use
scanf, and is the default storage for stdin/stdout/stderr.</p>
<p>Because SimFiles can have such diverse storage mechanisms, the interface for
interacting with them is <em>very</em> abstracted. You can read from the file from some
position, you can write to the file at some position, you can ask how many bytes
are currently stored in the file, and you can concretize the file, generating a
testcase for it. If you know specifically which SimFile class you’re working
with, you can take much more powerful control over it, and as a result you’re
encouraged to manually create any files you want to work with when you create
your initial state.</p>
<p>Specifically, each SimFile class creates its own abstraction of a “position”
within the file - each read and write takes a position and returns a new
position that you should use to continue from where you left off. If you’re
working with SimFiles of unknown type you have to treat this position as a
totally opaque object with no semantics other than the contract with the
read/write functions.</p>
<p>However! This is a very poor match to how programs generally interact with
files, so bisa also has a SimFileDescriptor abstraction, which provides the
familiar read/write/seek/tell interfaces but will also return error conditions
when the underlying storage don’t support the appropriate operations - just like
normal file descriptors!</p>
<p>You may access the mapping from file descriptor number to file descriptor object
in <code class="docutils literal notranslate"><span class="pre">state.posix.fd</span></code>. See the API document for
<a class="reference internal" href="../api.html#bisa.storage.file.SimFileDescriptorBase" title="bisa.storage.file.SimFileDescriptorBase"><code class="xref py py-class docutils literal notranslate"><span class="pre">bisa.storage.file.SimFileDescriptorBase</span></code></a> for more details.</p>
<section id="just-tell-me-how-to-do-what-i-want-to-do">
<h2>Just tell me how to do what I want to do!<a class="headerlink" href="#just-tell-me-how-to-do-what-i-want-to-do" title="Link to this heading">¶</a></h2>
<p>Okay okay!!</p>
<p>To create a SimFile, you should just create an instance of the class you want to
use. Refer to <a class="reference internal" href="../api.html#module-bisa.storage.file" title="bisa.storage.file"><code class="xref py py-mod docutils literal notranslate"><span class="pre">bisa.storage.file</span></code></a> for the full instructions.</p>
<p>Let’s go through a few illustrative examples, which cover how you can work with
a concrete file, a symbolic file, a file with mixed concrete and symbolic
content, or streams.</p>
<section id="example-1-create-a-file-with-concrete-content">
<h3>Example 1: Create a file with concrete content<a class="headerlink" href="#example-1-create-a-file-with-concrete-content" title="Link to this heading">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span><span class="w"> </span><span class="nn">bisa</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">simfile</span> <span class="o">=</span> <span class="n">bisa</span><span class="o">.</span><span class="n">SimFile</span><span class="p">(</span><span class="s1">&#39;myconcretefile&#39;</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="s1">&#39;hello world!</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Here’s a nuance - you can’t use SimFiles without a state attached, because
reasons. You’ll <strong>never</strong> have to do this in a real scenario (this operation
happens automatically when you pass a SimFile into a constructor or the
filesystem) but let’s mock it up:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">proj</span> <span class="o">=</span> <span class="n">bisa</span><span class="o">.</span><span class="n">Project</span><span class="p">(</span><span class="s1">&#39;/bin/true&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">state</span> <span class="o">=</span> <span class="n">proj</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">blank_state</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">simfile</span><span class="o">.</span><span class="n">set_state</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
</pre></div>
</div>
<p>To demonstrate the behavior of these files we’re going to use the fact that the
default SimFile position is just the number of bytes from the start of the file.
<code class="docutils literal notranslate"><span class="pre">SimFile.read</span></code> returns a tuple (bitvector data, actual size, new pos):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">data</span><span class="p">,</span> <span class="n">actual_size</span><span class="p">,</span> <span class="n">new_pos</span> <span class="o">=</span> <span class="n">simfile</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span><span class="w"> </span><span class="nn">claripy</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">assert</span> <span class="n">claripy</span><span class="o">.</span><span class="n">is_true</span><span class="p">(</span><span class="n">data</span> <span class="o">==</span> <span class="s1">&#39;hello&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">assert</span> <span class="n">claripy</span><span class="o">.</span><span class="n">is_true</span><span class="p">(</span><span class="n">actual_size</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">assert</span> <span class="n">claripy</span><span class="o">.</span><span class="n">is_true</span><span class="p">(</span><span class="n">new_pos</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
<p>Continue the read, trying to read way too much:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">data</span><span class="p">,</span> <span class="n">actual_size</span><span class="p">,</span> <span class="n">new_pos</span> <span class="o">=</span> <span class="n">simfile</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">new_pos</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
</pre></div>
</div>
<p>bisa doesn’t try to sanitize the data returned, only the size - we returned 1000
bytes! The intent is that you’re only allowed to use up to actual_size of them.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1000</span><span class="o">*</span><span class="mi">8</span>  <span class="c1"># bitvector sizes are in bits</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">assert</span> <span class="n">claripy</span><span class="o">.</span><span class="n">is_true</span><span class="p">(</span><span class="n">actual_size</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">assert</span> <span class="n">claripy</span><span class="o">.</span><span class="n">is_true</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">get_bytes</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39; world!</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">assert</span> <span class="n">claripy</span><span class="o">.</span><span class="n">is_true</span><span class="p">(</span><span class="n">new_pos</span> <span class="o">==</span> <span class="mi">13</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="example-2-create-a-file-with-symbolic-content-and-a-defined-size">
<h3>Example 2: Create a file with symbolic content and a defined size<a class="headerlink" href="#example-2-create-a-file-with-symbolic-content-and-a-defined-size" title="Link to this heading">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">simfile</span> <span class="o">=</span> <span class="n">bisa</span><span class="o">.</span><span class="n">SimFile</span><span class="p">(</span><span class="s1">&#39;mysymbolicfile&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mh">0x20</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">simfile</span><span class="o">.</span><span class="n">set_state</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">data</span><span class="p">,</span> <span class="n">actual_size</span><span class="p">,</span> <span class="n">new_pos</span> <span class="o">=</span> <span class="n">simfile</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">assert</span> <span class="n">data</span><span class="o">.</span><span class="n">symbolic</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">assert</span> <span class="n">claripy</span><span class="o">.</span><span class="n">is_true</span><span class="p">(</span><span class="n">actual_size</span> <span class="o">==</span> <span class="mh">0x20</span><span class="p">)</span>
</pre></div>
</div>
<p>The basic SimFile provides the same interface as <code class="docutils literal notranslate"><span class="pre">state.memory</span></code>, so you can load data directly:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">assert</span> <span class="n">simfile</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">actual_size</span><span class="p">)</span> <span class="ow">is</span> <span class="n">data</span><span class="o">.</span><span class="n">get_bytes</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="example-3-create-a-file-with-constrained-symbolic-content">
<h3>Example 3: Create a file with constrained symbolic content<a class="headerlink" href="#example-3-create-a-file-with-constrained-symbolic-content" title="Link to this heading">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">bytes_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">claripy</span><span class="o">.</span><span class="n">BVS</span><span class="p">(</span><span class="s1">&#39;byte_</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">i</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">32</span><span class="p">)]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">bytes_ast</span> <span class="o">=</span> <span class="n">claripy</span><span class="o">.</span><span class="n">Concat</span><span class="p">(</span><span class="o">*</span><span class="n">bytes_list</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">mystate</span> <span class="o">=</span> <span class="n">proj</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">entry_state</span><span class="p">(</span><span class="n">stdin</span><span class="o">=</span><span class="n">bisa</span><span class="o">.</span><span class="n">SimFile</span><span class="p">(</span><span class="s1">&#39;/dev/stdin&#39;</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">bytes_ast</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">byte</span> <span class="ow">in</span> <span class="n">bytes_list</span><span class="p">:</span>
<span class="gp">... </span>    <span class="n">mystate</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">byte</span> <span class="o">&gt;=</span> <span class="mh">0x20</span><span class="p">)</span>
<span class="gp">... </span>    <span class="n">mystate</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">byte</span> <span class="o">&lt;=</span> <span class="mh">0x7e</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="example-4-create-a-file-with-some-mixed-concrete-and-symbolic-content-but-no-eof">
<h3>Example 4: Create a file with some mixed concrete and symbolic content, but no EOF<a class="headerlink" href="#example-4-create-a-file-with-some-mixed-concrete-and-symbolic-content-but-no-eof" title="Link to this heading">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">variable</span> <span class="o">=</span> <span class="n">claripy</span><span class="o">.</span><span class="n">BVS</span><span class="p">(</span><span class="s1">&#39;myvar&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="o">*</span><span class="mi">8</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">simfile</span> <span class="o">=</span> <span class="n">bisa</span><span class="o">.</span><span class="n">SimFile</span><span class="p">(</span><span class="s1">&#39;mymixedfile&#39;</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">variable</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">claripy</span><span class="o">.</span><span class="n">BVV</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)),</span> <span class="n">has_end</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">simfile</span><span class="o">.</span><span class="n">set_state</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
</pre></div>
</div>
<p>We can always query the number of bytes stored in the file:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">assert</span> <span class="n">claripy</span><span class="o">.</span><span class="n">is_true</span><span class="p">(</span><span class="n">simfile</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">11</span><span class="p">)</span>
</pre></div>
</div>
<p>Reads will generate additional symbolic data past the current frontier:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">data</span><span class="p">,</span> <span class="n">actual_size</span><span class="p">,</span> <span class="n">new_pos</span> <span class="o">=</span> <span class="n">simfile</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">15</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">assert</span> <span class="n">claripy</span><span class="o">.</span><span class="n">is_true</span><span class="p">(</span><span class="n">actual_size</span> <span class="o">==</span> <span class="mi">15</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">assert</span> <span class="n">claripy</span><span class="o">.</span><span class="n">is_true</span><span class="p">(</span><span class="n">new_pos</span> <span class="o">==</span> <span class="mi">15</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="k">assert</span> <span class="n">claripy</span><span class="o">.</span><span class="n">is_true</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">get_bytes</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span> <span class="o">==</span> <span class="n">variable</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">assert</span> <span class="n">claripy</span><span class="o">.</span><span class="n">is_true</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">get_bytes</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">assert</span> <span class="n">data</span><span class="o">.</span><span class="n">get_bytes</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">symbolic</span>
</pre></div>
</div>
</section>
<section id="example-5-create-a-file-with-a-symbolic-size-has-end-is-implicitly-true-here">
<h3>Example 5: Create a file with a symbolic size (<code class="docutils literal notranslate"><span class="pre">has_end</span></code> is implicitly true here)<a class="headerlink" href="#example-5-create-a-file-with-a-symbolic-size-has-end-is-implicitly-true-here" title="Link to this heading">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">symsize</span> <span class="o">=</span> <span class="n">claripy</span><span class="o">.</span><span class="n">BVS</span><span class="p">(</span><span class="s1">&#39;mysize&#39;</span><span class="p">,</span> <span class="mi">64</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">state</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">symsize</span> <span class="o">&gt;=</span> <span class="mi">10</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">state</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">symsize</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">simfile</span> <span class="o">=</span> <span class="n">bisa</span><span class="o">.</span><span class="n">SimFile</span><span class="p">(</span><span class="s1">&#39;mysymsizefile&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">symsize</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">simfile</span><span class="o">.</span><span class="n">set_state</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
</pre></div>
</div>
<p>Reads will encode all possibilities:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">data</span><span class="p">,</span> <span class="n">actual_size</span><span class="p">,</span> <span class="n">new_pos</span> <span class="o">=</span> <span class="n">simfile</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">assert</span> <span class="nb">set</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">eval_upto</span><span class="p">(</span><span class="n">actual_size</span><span class="p">,</span> <span class="mi">30</span><span class="p">))</span> <span class="o">==</span> <span class="nb">set</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">))</span>
</pre></div>
</div>
<p>The maximum size can’t be easily resolved, so the data returned is 30 bytes long, and we’re supposed to use it conjunction with actual_size.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">30</span><span class="o">*</span><span class="mi">8</span>
</pre></div>
</div>
<p>Symbolic read sizes work too!</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">symreadsize</span> <span class="o">=</span> <span class="n">claripy</span><span class="o">.</span><span class="n">BVS</span><span class="p">(</span><span class="s1">&#39;myreadsize&#39;</span><span class="p">,</span> <span class="mi">64</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">state</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">symreadsize</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">state</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">symreadsize</span> <span class="o">&lt;</span> <span class="mi">30</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">data</span><span class="p">,</span> <span class="n">actual_size</span><span class="p">,</span> <span class="n">new_pos</span> <span class="o">=</span> <span class="n">simfile</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">symreadsize</span><span class="p">)</span>
</pre></div>
</div>
<p>All sizes between 5 and 20 should be possible:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">assert</span> <span class="nb">set</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">eval_upto</span><span class="p">(</span><span class="n">actual_size</span><span class="p">,</span> <span class="mi">30</span><span class="p">))</span> <span class="o">==</span> <span class="nb">set</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">20</span><span class="p">))</span>
</pre></div>
</div>
</section>
<section id="example-6-working-with-streams-simpackets">
<h3>Example 6: Working with streams (<code class="docutils literal notranslate"><span class="pre">SimPackets</span></code>)<a class="headerlink" href="#example-6-working-with-streams-simpackets" title="Link to this heading">¶</a></h3>
<p>So far, we’ve only used the SimFile class, which models a random-accessible file
object. However, in real life, files are not everything. Streams (standard I/O,
TCP, etc.) are a great example: While they hold data like a normal file does,
they do not support random accesses, e.g., you cannot read out the second byte
of stdin if you have already read passed that position, and you cannot modify
any byte that has been previously sent out to a network endpoint. This allows us
to design a simpler abstraction for streams in bisa.</p>
<p>Believe it or not, this simpler abstraction for streams will benefit symbolic
execution. Consider an example program that calls <code class="docutils literal notranslate"><span class="pre">scanf</span></code> N times to read in N
strings. With a traditional SimFile, as we do not know the length of each input
string, there does not exist any clear boundary in the file between these
symbolic input strings. In this case, bisa will perform N symbolic reads where
each read will generate a gigantic tree of claripy ASTs, with string lengths
being symbolic. This is a nightmare for constraint solving. Nevertheless, the
fact that <code class="docutils literal notranslate"><span class="pre">scanf</span></code> is used on a stream (stdin) dictates that there will be zero
overlap between individual reads, regardless of the sizes of each symbolic input
string. We may as well model stdin as a stream that comprises of <em>consecutive
packets</em>, instead of a file containing a sequence of bytes. Each of the packet
can be of a fixed length or a symbolic length. Since there will be absolutely no
byte overlap between packets, the constraints that bisa will produce after
executing this example program will be a lot simpler.</p>
<p>The key concept involved is “short reads”, i.e. when you ask for <code class="docutils literal notranslate"><span class="pre">n</span></code> bytes but
actually get back fewer bytes than that. We use a different class implementing
SimFileBase, <code class="docutils literal notranslate"><span class="pre">SimPackets</span></code>, to automatically enable support for short reads. By
default, stdin, stdout, and stderr are all SimPackets objects.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">simfile</span> <span class="o">=</span> <span class="n">bisa</span><span class="o">.</span><span class="n">SimPackets</span><span class="p">(</span><span class="s1">&#39;mypackets&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">simfile</span><span class="o">.</span><span class="n">set_state</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
</pre></div>
</div>
<p>This’ll just generate a single packet. For SimPackets, the position is just a
packet number! If left unspecified, short_reads is determined from a state
option.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">data</span><span class="p">,</span> <span class="n">actual_size</span><span class="p">,</span> <span class="n">new_pos</span> <span class="o">=</span> <span class="n">simfile</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="n">short_reads</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">20</span><span class="o">*</span><span class="mi">8</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">assert</span> <span class="nb">set</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">eval_upto</span><span class="p">(</span><span class="n">actual_size</span><span class="p">,</span> <span class="mi">30</span><span class="p">))</span> <span class="o">==</span> <span class="nb">set</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">21</span><span class="p">))</span>
</pre></div>
</div>
<p>Data in a SimPackets is stored as tuples of (packet data, packet size) in
<code class="docutils literal notranslate"><span class="pre">.content</span></code>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">simfile</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
<span class="go">[(&lt;BV160 packet_0_mypackets&gt;, &lt;BV64 packetsize_0_mypackets&gt;)]</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">simfile</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">short_reads</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">simfile</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
<span class="go">[(&lt;BV160 packet_0_mypackets&gt;, &lt;BV64 packetsize_0_mypackets&gt;), (&lt;BV8 packet_1_mypackets&gt;, &lt;BV64 0x1&gt;)]</span>
</pre></div>
</div>
<p>So hopefully you understand sort of the kind of data that a SimFile can store
and what’ll happen when a program tries to interact with it with various
combinations of symbolic and concrete data. Those examples only covered reads,
but writes are pretty similar.</p>
</section>
</section>
<section id="the-filesystem-for-real-now">
<h2>The filesystem, for real now<a class="headerlink" href="#the-filesystem-for-real-now" title="Link to this heading">¶</a></h2>
<p>If you want to make a SimFile available to the program, we need to either stick
it in the filesystem or serve stdin/stdout from it.</p>
<p>The simulated filesystem is the <code class="docutils literal notranslate"><span class="pre">state.fs</span></code> plugin. You can store, load, and
delete files from the filesystem, with the <code class="docutils literal notranslate"><span class="pre">insert</span></code>, <code class="docutils literal notranslate"><span class="pre">get</span></code>, and <code class="docutils literal notranslate"><span class="pre">delete</span></code>
methods. Refer to <a class="reference internal" href="../api.html#module-bisa.state_plugins.filesystem" title="bisa.state_plugins.filesystem"><code class="xref py py-mod docutils literal notranslate"><span class="pre">bisa.state_plugins.filesystem</span></code></a> for details.</p>
<p>So to make our file available as <code class="docutils literal notranslate"><span class="pre">/tmp/myfile</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">state</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="s1">&#39;/tmp/myfile&#39;</span><span class="p">,</span> <span class="n">simfile</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">assert</span> <span class="n">state</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;/tmp/myfile&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="n">simfile</span>
</pre></div>
</div>
<p>Then, after execution, we would extract the file from the result state and use
<code class="docutils literal notranslate"><span class="pre">simfile.concretize()</span></code> to generate a testcase to reach that state. Keep in
mind that <code class="docutils literal notranslate"><span class="pre">concretize()</span></code> returns different types depending on the file type -
for a SimFile it’s a bytestring and for SimPackets it’s a list of bytestrings.</p>
<p>The simulated filesystem supports a fun concept of “mounts”, where you can
designate a subtree as instrumented by a particular provider. The most common
mount is to expose a part of the host filesystem to the guest, lazily importing
file data when the program asks for it:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">state</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">mount</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="n">bisa</span><span class="o">.</span><span class="n">SimHostFilesystem</span><span class="p">(</span><span class="s1">&#39;./guest_chroot&#39;</span><span class="p">))</span>
</pre></div>
</div>
<p>You can write whatever kind of mount you want to instrument filesystem access by
subclassing <code class="docutils literal notranslate"><span class="pre">bisa.SimMount</span></code>!</p>
</section>
<section id="stdio-streams">
<h2>Stdio streams<a class="headerlink" href="#stdio-streams" title="Link to this heading">¶</a></h2>
<p>For stdin and friends, it’s a little more complicated. The relevant plugin is
<code class="docutils literal notranslate"><span class="pre">state.posix</span></code>, which stores all abstractions relevant to a POSIX-compliant
environment. You can always get a state’s stdin SimFile with
<code class="docutils literal notranslate"><span class="pre">state.posix.stdin</span></code>, but you can’t just replace it - as soon as the state is
created, references to this file are created in the file descriptors. Because of
this you need to specify it at the time the POSIX plugin is created:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">state</span><span class="o">.</span><span class="n">register_plugin</span><span class="p">(</span><span class="s1">&#39;posix&#39;</span><span class="p">,</span> <span class="n">bisa</span><span class="o">.</span><span class="n">state_plugins</span><span class="o">.</span><span class="n">posix</span><span class="o">.</span><span class="n">SimSystemPosix</span><span class="p">(</span><span class="n">stdin</span><span class="o">=</span><span class="n">simfile</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">simfile</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">simfile</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">assert</span> <span class="n">state</span><span class="o">.</span><span class="n">posix</span><span class="o">.</span><span class="n">stdin</span> <span class="ow">is</span> <span class="n">simfile</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">assert</span> <span class="n">state</span><span class="o">.</span><span class="n">posix</span><span class="o">.</span><span class="n">stdout</span> <span class="ow">is</span> <span class="n">simfile</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">assert</span> <span class="n">state</span><span class="o">.</span><span class="n">posix</span><span class="o">.</span><span class="n">stderr</span> <span class="ow">is</span> <span class="n">simfile</span>
</pre></div>
</div>
<p>Or, there’s a nice shortcut while creating the state if you only need to specify
stdin:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">state</span> <span class="o">=</span> <span class="n">proj</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">entry_state</span><span class="p">(</span><span class="n">stdin</span><span class="o">=</span><span class="n">simfile</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">assert</span> <span class="n">state</span><span class="o">.</span><span class="n">posix</span><span class="o">.</span><span class="n">stdin</span> <span class="ow">is</span> <span class="n">simfile</span>
</pre></div>
</div>
<p>Any of those places you can specify a SimFileBase, you can also specify a string
or a bitvector (a flat SimFile with fixed size will be created to hold it) or a
SimFile type (it’ll be instantiated for you).</p>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../index.html">bisa</a></h1>









<search id="searchbox" style="display: none" role="search">
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" placeholder="Search"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script><h3>Navigation</h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../quickstart.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting-started/index.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../core-concepts/index.html">Core Concepts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../analyses/index.html">Build-in Analyses</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Advanced Topics</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="gotchas.html">Gotchas when using bisa</a></li>
<li class="toctree-l2"><a class="reference internal" href="pipeline.html">Understanding the Execution Pipeline</a></li>
<li class="toctree-l2"><a class="reference internal" href="mixins.html">What’s Up With Mixins, Anyway?</a></li>
<li class="toctree-l2"><a class="reference internal" href="speed.html">Optimization considerations</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Working with File System, Sockets, and Pipes</a></li>
<li class="toctree-l2"><a class="reference internal" href="ir.html">Intermediate Representation</a></li>
<li class="toctree-l2"><a class="reference internal" href="structured_data.html">Working with Data and Conventions</a></li>
<li class="toctree-l2"><a class="reference internal" href="claripy.html">Solver Engine</a></li>
<li class="toctree-l2"><a class="reference internal" href="concretization_strategies.html">Symbolic memory addressing</a></li>
<li class="toctree-l2"><a class="reference internal" href="java_support.html">Java Support</a></li>
<li class="toctree-l2"><a class="reference internal" href="symbion.html">Symbion: Interleaving symbolic and concrete execution</a></li>
<li class="toctree-l2"><a class="reference internal" href="debug_var.html">Debug variable resolution</a></li>
<li class="toctree-l2"><a class="reference internal" href="debug_var.html#variable-visibility">Variable visibility</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../extending-bisa/index.html">Extending bisa</a></li>
<li class="toctree-l1"><a class="reference internal" href="../examples.html">bisa examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../faq.html">Frequently Asked Questions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../appendix/index.html">Appendix</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api.html">API Reference</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  <li><a href="index.html">Advanced Topics</a><ul>
      <li>Previous: <a href="speed.html" title="previous chapter">Optimization considerations</a></li>
      <li>Next: <a href="ir.html" title="next chapter">Intermediate Representation</a></li>
  </ul></li>
  </ul></li>
</ul>
</div>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2025, The bisa Project contributors.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 8.2.3</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 1.0.0</a>
      
      |
      <a href="../_sources/advanced-topics/file_system.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>